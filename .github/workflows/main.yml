on:
  push:
    branches-ignore:
    - gh-pages
    tags:
    - "*"
  schedule:
  - cron: 59 14 * * *
  pull_request: []
name: main

jobs:
  build:
    if: github.event_name != 'schedule' || github.repository == 'planetarium/libplanet'
    name: dist
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@main
      if: github.event_name != 'pull_request'
    - uses: actions/checkout@main
      if: github.event_name == 'pull_request'
      with:
        ref: ${{ github.pull_request.head.sha }}
    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    - uses: actions/setup-node@v1
      with:
        registry-url: 'https://registry.npmjs.org'
        scope: '@planetarium'
    - run: .github/bin/dist-version.ps1
      shell: pwsh
    - run: .github/bin/dist-release-note.sh CHANGES.md obj/release_note.txt
    - uses: actions/upload-artifact@main
      with:
        name: dist-obj
        path: obj/
    - run: .github/bin/dist-pack.sh
    - run: |
        . .github/bin/constants.sh
        mkdir -p /tmp/dist-bin/
        for project in "${projects[@]}"; do
          cp -r "$project/bin/$configuration"/* /tmp/dist-bin/
        done
    - uses: actions/upload-artifact@main
      with:
        name: dist-bin
        path: /tmp/dist-bin/
    - if: >-
        github.event_name != 'pull_request' &&
        startsWith(github.ref, 'refs/tags/')
      run: .github/bin/dist-github-release.sh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - if: github.event_name != 'pull_request' && env.NUGET_API_KEY != ''
      run: .github/bin/dist-nuget.sh
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
    - if: >-
        github.event_name != 'pull_request' &&
        startsWith(github.ref, 'refs/tags/') &&
        env.NODE_AUTH_TOKEN != ''
      run: .github/bin/dist-npm.sh
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

  docs:
    if: github.event_name != 'schedule' || github.repository == 'planetarium/libplanet'
    name: docs
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@main
      if: github.event_name != 'pull_request'
    - uses: actions/checkout@main
      if: github.event_name == 'pull_request'
      with:
        ref: ${{ github.pull_request.head.sha }}
    - run: git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    - run: dotnet build -p:SkipSonar=true
    - run: mkdir -p Docs/obj/
    - run: Docs/build.ps1
      shell: pwsh
    - uses: actions/upload-artifact@main
      with:
        name: docs
        path: Docs/_site/
    - run: Docs/publish.sh
      env:
        GHPAGES_SSH_KEY: ${{ secrets.GHPAGES_SSH_KEY }}
      if: github.event_name != 'pull_request'
    - id: docs-url
      run: 'echo ::set-output name=url::"$(cat Docs/obj/url.txt)"'
      if: github.event_name != 'pull_request'
    - uses: Sibz/github-status-action@v1.1.6
      with:
        authToken: ${{ secrets.GITHUB_TOKEN }}
        context: docs
        description: Libplanet docs generated by DocFX
        state: 'success'
        target_url: ${{ steps.docs-url.outputs.url }}
      if: github.event_name != 'pull_request'

  bundle:
    name: bundle
    needs: [build]
    runs-on: ubuntu-20.04
    steps:
    - run: sudo apt-get install nuget
    - uses: actions/checkout@main
      if: github.event_name != 'pull_request'
    - uses: actions/checkout@main
      if: github.event_name == 'pull_request'
      with:
        ref: ${{ github.pull_request.head.sha }}
    - uses: actions/download-artifact@main
      with:
        name: dist-bin
        path: /tmp/nupkg
    - run: |
        targets=(netcoreapp3.1 net472 net462 net461)
        for target in "${targets[@]}"; do
          find /tmp/nupkg \
            -name '*.nupkg' \
            -exec .github/bin/bundle.sh {} /tmp/bundles "$target" ';'
        done
      shell: bash
    - uses: actions/upload-artifact@main
      with:
        name: bundles
        path: /tmp/bundles
    - if: >-
        github.event_name != 'pull_request' &&
        startsWith(github.ref, 'refs/tags/')
      run: |
        tag="${GITHUB_REF#refs/*/}"
        github_user="${GITHUB_REPOSITORY%/*}"
        github_repo="${GITHUB_REPOSITORY#*/}"
        if [[ -d /tmp/bundles && "$(ls /tmp/bundles | wc -l)" -gt 0 ]]; then
          for bundle in /tmp/bundles/*; do
            .github/bin/github-release.sh upload \
              --user "$github_user" \
              --repo "$github_repo" \
              --tag "$tag" \
              --name "$(basename "$bundle")" \
              --file "$bundle"
          done
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
